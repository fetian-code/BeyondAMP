from sim2simlib.mimic.config import Sim2SimBeyondMimicCfg, BeyondMimicObservationsCfg, BeyondMimicDatasetCfg
from sim2simlib.mimic.sim2sim_beyond_mimic import Sim2SimBeyondMimic
from sim2simlib import MUJOCO_ASSETS
from sim2simlib.model.config import Sim2SimCfg, ObservationsCfg, ActionsCfg, MotorCfg
from sim2simlib.model.actuator_motor import DCMotor, PIDMotor
import numpy as np

dataset_dirs=[
    "data/datasets"
]

CHECKPOINT_DIR = ""

config = Sim2SimBeyondMimicCfg(
    robot_name='g1',
    simulation_dt=0.005,
    slowdown_factor=1.0,
    control_decimation=4,
    xml_path=f"{MUJOCO_ASSETS['unitree_g1_29dof']}",
    policy_path=str(CHECKPOINT_DIR/"g1_mimic.pt"),
    policy_joint_names=['left_hip_pitch_joint', 
                        'right_hip_pitch_joint', 
                        'waist_yaw_joint', 
                        'left_hip_roll_joint', 
                        'right_hip_roll_joint', 
                        'waist_roll_joint', 
                        'left_hip_yaw_joint', 
                        'right_hip_yaw_joint', 
                        'waist_pitch_joint', 
                        'left_knee_joint', 
                        'right_knee_joint', 
                        'left_shoulder_pitch_joint', 
                        'right_shoulder_pitch_joint', 
                        'left_ankle_pitch_joint', 
                        'right_ankle_pitch_joint', 
                        'left_shoulder_roll_joint', 
                        'right_shoulder_roll_joint', 
                        'left_ankle_roll_joint', 
                        'right_ankle_roll_joint', 
                        'left_shoulder_yaw_joint', 
                        'right_shoulder_yaw_joint', 
                        'left_elbow_joint', 
                        'right_elbow_joint', 
                        'left_wrist_roll_joint', 
                        'right_wrist_roll_joint', 
                        'left_wrist_pitch_joint', 
                        'right_wrist_pitch_joint', 
                        'left_wrist_yaw_joint', 
                        'right_wrist_yaw_joint'],
    policy_body_names = ['pelvis', 
                     'left_hip_pitch_link', 
                     'right_hip_pitch_link',
                     'waist_yaw_link',
                     'left_hip_roll_link', 
                     'right_hip_roll_link', 
                     'waist_roll_link',
                     'left_hip_yaw_link', 
                     'right_hip_yaw_link', 
                     'torso_link', 
                     'left_knee_link', 
                     'right_knee_link', 
                     'left_shoulder_pitch_link', 
                     'right_shoulder_pitch_link', 
                     'left_ankle_pitch_link', 
                     'right_ankle_pitch_link', 
                     'left_shoulder_roll_link', 
                     'right_shoulder_roll_link', 
                     'left_ankle_roll_link', 
                     'right_ankle_roll_link', 
                     'left_shoulder_yaw_link', 
                     'right_shoulder_yaw_link', 
                     'left_elbow_link', 
                     'right_elbow_link', 
                     'left_wrist_roll_link', 
                     'right_wrist_roll_link', 
                     'left_wrist_pitch_link', 
                     'right_wrist_pitch_link', 
                     'left_wrist_yaw_link', 
                     'right_wrist_yaw_link'],
    observation_cfg=BeyondMimicObservationsCfg(
        base_observations_terms=['base_lin_vel',
                                 'base_ang_vel', 
                                 'joint_pos', 
                                 'joint_vel',
                                 'last_action'],
        scale={
                'base_lin_vel': 1.0,
                'base_ang_vel': 1.0,
                'joint_pos': 1.0,
                'joint_vel': 1.0,
                'last_action': 1.0
            },
        motion_observations_terms=[
            'motion_command',
            'motion_anchor_pos_ori_b',
            ],
        using_base_obs_history=False,
        base_obs_flatten=False,
        base_obs_his_length=1,
        ),
    action_cfg=ActionsCfg(
        action_clip=(-100.0, 100.0),
        scale={
            '.*_hip_yaw_joint': 0.5475464652142303,
            '.*_hip_roll_joint': 0.3506614663788243,
            '.*_hip_pitch_joint': 0.5475464652142303,
            '.*_knee_joint': 0.3506614663788243,
            '.*_ankle_pitch_joint': 0.43857731392336724,
            '.*_ankle_roll_joint': 0.43857731392336724,
            'waist_roll_joint': 0.43857731392336724,
            'waist_pitch_joint': 0.43857731392336724,
            'waist_yaw_joint': 0.5475464652142303,
            '.*_shoulder_pitch_joint': 0.43857731392336724,
            '.*_shoulder_roll_joint': 0.43857731392336724,
            '.*_shoulder_yaw_joint': 0.43857731392336724,
            '.*_elbow_joint': 0.43857731392336724,
            '.*_wrist_roll_joint': 0.43857731392336724,
            '.*_wrist_pitch_joint': 0.07450087032950714,
            '.*_wrist_yaw_joint': 0.07450087032950714
        }
    ),
    
    motor_cfg=MotorCfg(
        motor_type=PIDMotor,
        effort_limit={
            # "legs"
            ".*_hip_yaw_joint": 88.0,
            ".*_hip_roll_joint": 139.0,
            ".*_hip_pitch_joint": 88.0,
            ".*_knee_joint": 139.0,
            # "arms"
            ".*_shoulder_pitch_joint": 25.0,
            ".*_shoulder_roll_joint": 25.0,
            ".*_shoulder_yaw_joint": 25.0,
            ".*_elbow_joint": 25.0,
            ".*_wrist_roll_joint": 25.0,
            ".*_wrist_pitch_joint": 5.0,
            ".*_wrist_yaw_joint": 5.0,
            # "feet"
            ".*_ankle_pitch_joint": 50.0,
            ".*_ankle_roll_joint": 50.0,
            # "waist"
            "waist_roll_joint": 50.0,
            "waist_pitch_joint": 50.0,
            "waist_yaw_joint": 88.0,
            
        },
        stiffness={
            # "legs"
            ".*_hip_pitch_joint": 40.17923847137318,
            ".*_hip_roll_joint": 99.09842777666113,
            ".*_hip_yaw_joint": 40.17923847137318,
            ".*_knee_joint": 99.09842777666113,
            # "arms"
            ".*_shoulder_pitch_joint": 14.25062309787429,
            ".*_shoulder_roll_joint": 14.25062309787429,
            ".*_shoulder_yaw_joint": 14.25062309787429,
            ".*_elbow_joint": 14.25062309787429,
            ".*_wrist_roll_joint": 14.25062309787429,
            ".*_wrist_pitch_joint": 16.77832748089279,
            ".*_wrist_yaw_joint": 16.77832748089279,
            # "feet"
            ".*_ankle_pitch_joint": 28.50124619574858,
            ".*_ankle_roll_joint": 28.50124619574858,
            # "waist"
            "waist_roll_joint": 28.50124619574858,
            "waist_pitch_joint": 28.50124619574858,
            "waist_yaw_joint": 40.17923847137318,
        },
        damping={
            # "legs"
            ".*_hip_pitch_joint": 2.5578897650279457,
            ".*_hip_roll_joint": 6.3088018534966395,
            ".*_hip_yaw_joint": 2.5578897650279457,
            ".*_knee_joint": 6.3088018534966395,
            # "arms"
            ".*_shoulder_pitch_joint": 0.907222843292423,
            ".*_shoulder_roll_joint": 0.907222843292423,
            ".*_shoulder_yaw_joint": 0.907222843292423,
            ".*_elbow_joint": 0.907222843292423,
            ".*_wrist_roll_joint": 0.907222843292423,
            ".*_wrist_pitch_joint": 1.06814150219,
            ".*_wrist_yaw_joint": 1.06814150219,
            # "feet"
            ".*_ankle_pitch_joint": 1.814445686584846,
            ".*_ankle_roll_joint": 1.814445686584846,
            # "waist"
            "waist_roll_joint": 1.814445686584846,
            "waist_pitch_joint": 1.814445686584846,
            "waist_yaw_joint": 2.5578897650279457,
        },
    ),
    default_pos=np.array([0.0, 0.0, 0.76], dtype=np.float32),
    default_angles={
            ".*_hip_pitch_joint": -0.312,
            ".*_knee_joint": 0.669,
            ".*_ankle_pitch_joint": -0.363,
            ".*_elbow_joint": 0.6,
            "left_shoulder_roll_joint": 0.2,
            "left_shoulder_pitch_joint": 0.2,
            "right_shoulder_roll_joint": -0.2,
            "right_shoulder_pitch_joint": 0.2,
    },
    mimic_dataset_cfg=BeyondMimicDatasetCfg(
        dataset_dirs=dataset_dirs,
        robot_name='g1',
        splits=['walk_subset'],
        anchor_body_name='torso_link',
        motion_body_names=[
            "pelvis",
            "left_hip_roll_link",
            "left_knee_link",
            "left_ankle_roll_link",
            "right_hip_roll_link",
            "right_knee_link",
            "right_ankle_roll_link",
            "torso_link",
            "left_shoulder_roll_link",
            "left_elbow_link",
            "left_wrist_yaw_link",
            "right_shoulder_roll_link",
            "right_elbow_link",
            "right_wrist_yaw_link",
        ],
        dataset_body_names=[
            "pelvis",
            "left_hip_roll_link",
            "left_knee_link",
            "left_ankle_roll_link",
            "right_hip_roll_link",
            "right_knee_link",
            "right_ankle_roll_link",
            "torso_link",
            "left_shoulder_roll_link",
            "left_elbow_link",
            "left_wrist_yaw_link",
            "right_shoulder_roll_link",
            "right_elbow_link",
            "right_wrist_yaw_link",
        ],
        device='cuda',
    ),
    debug=False,
    cmd=None,
)

mujoco_model = Sim2SimBeyondMimic(config)
mujoco_model.view_run(11)